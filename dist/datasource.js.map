{"version":3,"sources":["../src/datasource.js"],"names":["_","Util","CmsSigner","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","basePath","url","name","jsonData","q","util","headers","cmsVersion","ecsVersion","ecsBasePath","rdsVersion","rdsBasePath","options","requests","result","targets","forEach","target","project","metric","ycol","xcol","describe","exists","resolve","period","group","dimensions","dimensions_varabiles","dimension","push","ycol_varabiles","y_col","indexOf","length","dimensionAcsJson","dimensionAcsObj","toString","replace","JSON","stringify","i","includes","dimension_i","queryConcat","parseInt","range","from","_d","getTime","to","param","path","method","query","buildRealUrl","isEmpty","d","defer","data","promise","request","datasourceRequest","then","response","status","Code","resResult","dataDatapoints","angular","fromJson","Datapoints","target_datapoints","instanceId","arr","map","datapoints","datapoint","Datapoint","ycolTarget","concat","parse","catch","error","console","log","Promise","all","p","e","ErrorCode","Success","message","title","namespacesQuery","match","filter","templateToStr","getProject","namespaces","namespace","text","metricsQuery","getMetrics","metrics","tagFilterQuery","regionId","tagType","tagKey","nextToken","tagsFilter","toUpperCase","arrayToMap","tagsList","dimensionsQuery","instanceId_array","strToArray","filter_array","getDimensions","is_instanceId_bool","is_filter_bool","instanceId_result","tagQuery","resourceId","resourceId_array","tag","tag_array","listTagResources","Resources","Resource","resource","Project","acs_param","UserId","Metric","Periods","split","statistics","Statistics","groupInfo","groupId","GroupId","groupName","GroupName","value","endTime","Date","startTime","data_meta","response_meta","Dimensions","datapointInfo","index","reqUrl","realUrl","buildECSRealUrl","tags","Tags","Tag","TagKey","TagValue","buildRDSRealUrl","Items","TagInfos","resourceType","v","tag_key_array","tag_value_array","t","t_split","key","tagList","distinct_result","rep","tagResource","TagResources","TagResource","ResourceId","NextToken","nextList","signer","accessKeyId","base64_decode","cmsAccessKey","secretAccessKey","cmsSecretKey","version","addAuthorization","obj","re","RegExp","test"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nimport {Util} from './util.js';\nimport {CmsSigner} from \"./signer.js\";\n\nexport class GenericDatasource {\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.basePath = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.jsonData = instanceSettings.jsonData;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.util = new Util(templateSrv);\n    this.headers = {'Content-Type': 'application/json'};\n    this.cmsVersion = \"2018-03-08\";\n    this.ecsVersion = \"2014-05-26\";\n    this.ecsBasePath = \"https://ecs.aliyuncs.com\";\n    this.rdsVersion = \"2014-08-15\";\n    this.rdsBasePath = \"https://rds.aliyuncs.com\";\n  }\n\n  query(options){\n    var requests = []\n    var result =[];\n    options.targets.forEach(target => {\n        //非空参数判空处理\n        if(!target.project || !target.metric || !target.ycol || !target.xcol){\n          return;\n        }\n        //默认数据\n        var ycol = target.ycol;\n        var xcol = target.xcol;\n        var describe = !target.describe ? target.describe : target.describe +\".\";\n        //处理模版\n        var project = this.util.exists(target.project) ? this.util.resolve(target.project, {}):target.project;\n        var metric = this.util.exists(target.metric) ? this.util.resolve(target.metric, {}):target.metric;\n        var period = this.util.exists(target.period) ? this.util.resolve(target.period, {}):target.period;\n        var group = this.util.exists(target.group) ? this.util.resolve(target.group, {}):target.group;\n        //处理数组模版\n        var dimensions = \"\";\n        var dimensions_varabiles = [];\n        \n        target.dimensions.forEach(dimension => {\n            this.util.exists(dimension) ? dimensions_varabiles.push(this.util.resolve(dimension, {})) : dimensions_varabiles.push(dimension)\n        });\n        var ycol_varabiles = [];\n        ycol.forEach(y_col => {\n          y_col.indexOf(\"$\") != -1 ? ycol_varabiles.push(this.util.resolve(y_col, {})) : ycol_varabiles.push(y_col)\n        });\n        ycol = ycol_varabiles.length > 0 ? ycol_varabiles : ycol;\n        \n        //自定义监控(acs_custom)、日志监控(acs_logMonitor)处理,只取下标为0的数据\n        if(project.indexOf(\"acs_custom\") != -1 || project.indexOf(\"acs_logMonitor\") != -1){\n          var dimensionAcsJson = target.dimensions[0];\n          var dimensionAcsObj = {\"groupId\":group.toString(),\n                          \"dimension\":dimensionAcsJson.replace(/\\&/gi, '%26').replace(/\\{/gi, '%7B').replace(/\\}/gi, '%7D')};\n          dimensions = JSON.stringify(dimensionAcsObj);\n        }else{\n          //正常数据\n          dimensions = \"\"\n          dimensions_varabiles.forEach((dimension,i) =>{\n            if(typeof dimension == \"string\"){\n              dimension = dimension.includes(\"{\") ? dimension :  \"{\" + dimension;\n              dimension = dimension.includes(\"}\") ? dimension : dimension + \"}\";\n\n              dimensions += dimension;\n              if(i != dimensions_varabiles.length - 1){\n                dimensions += \",\"\n              }\n            }else{\n              dimension.forEach(dimension_i =>{\n                dimension_i = dimension_i.includes(\"{\") ? dimension_i : \"{\" + dimension_i;\n                dimension_i = dimension_i.includes(\"}\") ? dimension_i : dimension_i + \"}\";\n\n                dimensions += dimension_i;\n                if(i != dimensions_varabiles.length - 1){\n                  dimensions += \",\"\n                }\n              })\n            }\n          })\n          dimensions = \"[\" + dimensions + \"]\"\n          dimensions = dimensions.replace(/\\&/gi, '%26').replace(/\\{/gi, '%7B').replace(/\\}/gi, '%7D');\n        }\n        //拼接url参数\n        var queryConcat = \"/?Action=QueryMetricList&Length=90000&Project=\" + project + \"&Metric=\" + metric + \"&Period=\" + period + \n                        \"&Dimensions=\" + dimensions + \"&StartTime=\" + (parseInt(options.range.from._d.getTime())) +\n                        \"&EndTime=\" + (parseInt(options.range.to._d.getTime()));\n        var param = {\n            path: queryConcat,\n            method: \"GET\"\n        };\n        // 签名已拼接的待查询URL\n        var query = this.buildRealUrl(param);\n        if (_.isEmpty(query)) {\n            var d = this.q.defer();\n            d.resolve({data: []});\n            return d.promise;\n        } \n        //定义Promise元数据、根据URL发起请求\n        var request = this.backendSrv.datasourceRequest({\n          url: query,\n          method: 'GET',\n          headers: this.headers\n        }).then(response => {\n          if(response.status == '200' && response.data.Code == '200'){\n            var resResult = [];\n            var dataDatapoints = angular.fromJson(response.data.Datapoints);\n            //处理数据分类\n            var target_datapoints = [];\n            if(dimensions.includes(\"instanceId\")){\n              for(var i in dataDatapoints){\n                if (!target_datapoints[dataDatapoints[i].instanceId]) {\n                  var arr = [];\n                  arr.push(dataDatapoints[i]);\n                  target_datapoints[dataDatapoints[i].instanceId] = arr;\n                }else{\n                  target_datapoints[dataDatapoints[i].instanceId].push(dataDatapoints[i]);\n                }\n              }\n            }\n            // 处理Grafana所需的target值、Target组的所需返回结果集\n            ycol.map(ycolTarget => {\n              if(dimensions.includes(\"instanceId\")){\n                for(var i in target_datapoints){\n                  var datapoints = [];\n                  target_datapoints[i].forEach(Datapoint=>{\n                    var datapoint = [];\n                    datapoint.push(Datapoint[ycolTarget], Datapoint[xcol]);\n                    // 封装返回目标的第二层数组值\n                    datapoints.push(datapoint);\n                  })\n                  // 封装返回目标的第三层数组值\n                  resResult.push({\n                    \"target\": describe + i + \".\" + ycolTarget,\n                    \"datapoints\": datapoints\n                  });\n                };\n              }else{\n                var datapoints = [];\n                dataDatapoints.forEach(Datapoint=>{\n                  var datapoint = [];\n                  datapoint.push(Datapoint[ycolTarget], Datapoint[xcol]);\n                  // 封装返回目标的第二层数组值\n                  datapoints.push(datapoint);\n                })\n                // 封装返回目标的第三层数组值\n                resResult.push({\n                  \"target\": describe + ycolTarget,\n                  \"datapoints\": datapoints\n                });\n              }\n            });\n            // 转对象封装\n            result = result.concat(typeof resResult == 'string' ? JSON.parse(resResult) : resResult);\n          }\n        }).catch(function (error) {\n          console.log(error);\n        });\n        requests.push(request);\n      })\n    // 统一单独处理返回值\n    return Promise.all(requests.map(p => p.catch(e => e))).then(() => { return {data: result}; });\n  } \n\n  // 测试连接数据源接口\n  testDatasource() {\n      var param = {\n          path: \"/?Action=AccessKeyGet\",\n          method: \"GET\"\n      };\n      return this.backendSrv.datasourceRequest({\n          url: this.buildRealUrl(param),\n          method: 'GET'\n      }).then(response => {\n          var data = response.data;\n          if (data.ErrorCode == 200 && data.Success == true ) {\n              return {status: \"success\", message: \"Data source is working\", title: \"Success\"};\n          }\n      });\n  }\n\n  annotationQuery(options){\n\n  } \n\n  metricFindQuery(options){\n      var result = []\n      //接受一个参数\n      var namespacesQuery = options.match(/^namespaces\\(([^\\)]+?)(,\\s?([^,]+?))?\\)/);\n      namespacesQuery = namespacesQuery == null ? options.match(/^namespace\\(([^\\)]+?)(,\\s?([^,]+?))?\\)/) : namespacesQuery;\n      if(namespacesQuery != null){\n        var filter = this.util.templateToStr(namespacesQuery[1]);\n        return this.getProject().then(namespaces => {\n          result = namespaces\n          if(!this.isEmpty(filter)){\n            result = []\n            namespaces.map(namespace =>{\n              if(namespace.text.includes(filter)){\n                result.push(namespace)\n              }\n            })\n          }\n          return result;\n        })\n      }\n      \n      //接受二个参数\n      var metricsQuery = options.match(/^metrics\\(([^,]+?),\\s?([^,]+?)\\)/);\n      metricsQuery = metricsQuery == null ? options.match(/^metric\\(([^,]+?),\\s?([^,]+?)\\)/) : metricsQuery;\n      if(metricsQuery != null){\n        var namespace = this.util.templateToStr(metricsQuery[1]);\n        var filter = this.util.templateToStr(metricsQuery[2]);\n\n        result = []\n        return this.getMetrics(namespace).then(metrics => {\n          result = metrics\n          if(!this.isEmpty(filter)){\n            result = []\n            metrics.map(metric =>{\n              if(metric.text.includes(filter)){\n                result.push(metric)\n              }\n            })\n          }\n          return result;\n        })\n      }\n\n      //接受四个参数，过滤Tag提供key、value选择\n      var tagFilterQuery = options.match(/^tagFilter\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/);\n      tagFilterQuery = tagFilterQuery == null ? options.match(/^tagsFilter\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/) : tagFilterQuery;\n      if(tagFilterQuery != null){\n        var type = this.util.templateToStr(tagFilterQuery[1]);\n        var regionId = this.util.templateToStr(tagFilterQuery[2]);\n        var tagType = this.isEmpty(tagFilterQuery[3]) ? \"\" : tagFilterQuery[3];\n        var tagKey = this.isEmpty(tagFilterQuery[4]) ? \"\" : tagFilterQuery[4];\n        var path = \"/?Action=DescribeTags&RegionId=\"+regionId;\n        var nextToken = \"\";\n        result = [];\n        return this.tagsFilter(type.toUpperCase(), nextToken, path, tagType, tagKey).then(tagsList => {\n          return this.util.arrayToMap(tagsList);\n        })\n      }\n\n      //接受四个参数,暂不支持数组，提供dimensions选择\n      var dimensionsQuery = options.match(/^dimension\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/);\n      dimensionsQuery = dimensionsQuery == null ? options.match(/^dimensions\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/) : dimensionsQuery;\n      if(dimensionsQuery != null){\n        var namespace = this.util.templateToStr(dimensionsQuery[1]);\n        var metric =this.util.templateToStr(dimensionsQuery[2]);\n\n        var instanceId = dimensionsQuery[3]\n        var instanceId_array = this.util.exists(instanceId) ? this.util.resolve(instanceId, {}):[];\n        if(instanceId_array.length == 0){\n          if(this.isEmpty(instanceId)){\n            instanceId_array = [];\n          }else{\n            instanceId_array = this.util.strToArray(instanceId);\n          }\n        }\n        var filter = dimensionsQuery[4]\n        var filter_array = this.util.exists(filter) ? this.util.resolve(filter, {}):[];\n        if(filter_array.length == 0){\n          if(this.isEmpty(filter)){\n            filter_array = [];\n          }else{\n            filter_array = this.util.strToArray(filter);\n          }\n        }\n        result = []\n        return this.getDimensions(namespace, metric, \"\", []).then(dimensions => {\n          var is_instanceId_bool = this.isEmpty(instanceId);\n          var is_filter_bool = this.isEmpty(filter);\n          if(is_instanceId_bool){\n            result = dimensions;\n          }else{\n            var instanceId_result = [];\n            dimensions.map(dimension => {\n              instanceId_array.forEach(i => {\n                if(dimension.text.includes(i)){\n                  instanceId_result.push(dimension);\n                }\n              })\n            })\n            if(is_filter_bool){\n              result = instanceId_result\n            }else{\n              instanceId_result.map(dimension =>{\n                filter_array.forEach( i => {\n                  if(dimension.text.includes(i)){\n                    result.push(dimension)\n                  }\n                })\n              })\n            }\n          }\n          return result;\n        })\n      }\n\n      //接受5个参数,暂不支持数组，提供tag选择\n      var tagQuery = options.match(/^tag\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/);\n      tagQuery = tagQuery == null ? options.match(/^tags\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/) : tagQuery;\n      if(tagQuery != null){\n        var resourceId = tagQuery[4];\n        var resourceId_array = this.util.exists(resourceId) ? this.util.resolve(resourceId, {}):[];\n        if(resourceId_array.length == 0){\n          if(this.isEmpty(resourceId)){\n            resourceId_array = [];\n          }else{\n            resourceId_array = [];\n            resourceId_array = this.util.strToArray(resourceId);\n          }\n        }\n        var tag = tagQuery[5];\n        var tag_array = this.util.exists(tag) ? this.util.resolve(tag, {}):[];\n        if(tag_array.length == 0){\n          if(this.isEmpty(tag)){\n            tag_array = [];\n          }else{\n            tag_array = [];\n            tag_array = this.util.strToArray(tag);\n          }\n        }\n        return this.listTagResources(tagQuery[1].toUpperCase(), tagQuery[2], tagQuery[3], resourceId_array, tag_array);\n      }\n      return []\n  }\n\n  //返回所有的Project,QueryProjectMeta的API无自定义监控project、日志监控project，已拼接\n  getProject(){\n    var param = {\n        path: \"/?Action=QueryProjectMeta&PageNumber=1&PageSize=1000\",\n        method: \"GET\"\n    };\n    return this.backendSrv.datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: 'GET'\n    }).then(response => {\n        var result =[];\n        var data = response.data;\n        if (data.ErrorCode == 200 && data.Success == true) {\n          data.Resources.Resource.map(resource =>{\n            if(!this.isEmpty(resource.Project)){\n              result.push(resource.Project);\n            }\n          })\n        }\n        //增加自定义监控、日志监控选项\n        var acs_param = {\n            path: \"/?Action=AccessKeyGet\",\n            method: \"GET\"\n        };\n        return this.backendSrv.datasourceRequest({\n          url: this.buildRealUrl(acs_param),\n          method: 'GET'\n        }).then(response => {\n          var data = response.data;\n          if (data.ErrorCode == 200 && data.Success == true ) {\n              result.push(\"acs_logMonitor_\" + data.UserId);\n              result.push(\"acs_customMetric_\" + data.UserId);\n          }\n          return this.util.arrayToMap(result);\n        });\n    }).catch(function (error) {\n      console.log(error);\n      return;\n    });\n  }\n\n  //根据Project返回对应的所有的Metrics,无自定义监控、日志监控project对应的Metrics\n  getMetrics(project){\n    var param = {\n        path: \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1000&Project=\" + project,\n        method: \"GET\"\n    };\n    return this.backendSrv.datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: 'GET'\n    }).then(response => {\n        var data = response.data;\n        if (data.ErrorCode == 200 && data.Success == true) {\n          var result =[];\n          data.Resources.Resource.map(resource =>{\n            if(!this.isEmpty(resource.Metric)){\n              result.push(resource.Metric);\n            }\n          })\n          return this.util.arrayToMap(result);\n        }\n    }).catch(function (error) {\n      console.log(error);\n      return;\n    });\n  }\n\n  //根据Project及Metrics返回对应的所有的Period,无自定义监控、日志监控project对应的Period\n  getPeriod(project,metric){\n    var param = {\n        path: \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1&Project=\"+ project + \"&Metric=\" + metric,\n        method: \"GET\"\n    };\n    return this.backendSrv.datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: 'GET'\n    }).then(response => {\n        var data = response.data;\n        if (data.ErrorCode == 200 && data.Success == true) {\n          var period = [];\n          var resource = data.Resources.Resource;\n          if(resource.length > 0 && !this.isEmpty(resource[0].Periods)){\n            period =resource[0].Periods.split(\",\");\n          }\n          return this.util.arrayToMap(period);\n        }\n    }).catch(function (error) {\n      console.log(error);\n      return;\n    });\n  }\n\n  //根据Project及Metrics返回对应的所有的Statistics,未去除已选项,无自定义监控、日志监控project对应的Period\n  getStatistics(project,metric){\n    var param = {\n        path: \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1&Project=\" + project + \"&Metric=\" + metric,\n        method: \"GET\"\n    };\n    return this.backendSrv.datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: 'GET'\n    }).then(response => {\n        var data = response.data;\n        if (data.ErrorCode == 200 && data.Success == true) {\n          var statistics=[];\n          var resource = data.Resources.Resource;\n          if(resource.length > 0 && !this.isEmpty(resource[0].Statistics)){\n            statistics = resource[0].Statistics.split(\",\");\n          }\n          return this.util.arrayToMap(statistics);\n        }\n    }).catch(function (error) {\n      console.log(error);\n      return;\n    });\n  }\n\n  //返回所有的Groups,自定义监控、日志使用\n  getGroups(){\n    var param = {\n        path: \"/?Action=ListMyGroups&PageNumber=1&PageSize=9000\",\n        method: \"GET\"\n    };\n    return this.backendSrv.datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: 'GET'\n    }).then(response => {\n      var data = response.data;\n      if (data.ErrorCode == 200 && data.Success == true) {\n        var result =[];\n        var resource = data.Resources.Resource;\n        var i = resource.length;\n        while (i--) {\n            var group = resource[i];\n            var groupInfo =[];\n            var groupId = group.GroupId;\n            var groupName = group.GroupName;\n            if(this.isEmpty(groupId) || this.isEmpty(groupName)){\n               continue;\n            }\n            groupInfo.push(groupId,groupName + \" / \" + groupId);\n            result.push(groupInfo);\n        }\n        return _.map(result, (d, i) => {\n          return { text: d[1], value: d[0]};\n        });\n      }\n    }).catch(function (error) {\n      console.log(error);\n      return;\n    });\n  }\n\n  getDimensions(project,metric,period,dimensions){\n    if(project.indexOf(\"acs_customMetric\") != -1 || project.indexOf(\"acs_logMonitor\") != -1){\n      return;\n    }\n    var result =[];\n    var endTime = new Date().getTime();\n    var startTime = endTime - 1 * 60 * 60 * 1000;\n    var param = {\n        path: \"/?Action=QueryMetricLast&Page=1&Length=90000&Period=\"+period+\"&Project=\" \n              + project + \"&Metric=\" + metric + \"&StartTime=\" + startTime + \"&EndTime=\" + endTime,\n        method: \"GET\"\n    };\n    return this.backendSrv.datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: 'GET'\n    }).then(response => {\n      var data = response.data;\n      if(data.Success == false){\n          return;\n      }\n      // 构建可选参数dimensions\n      param = {\n        path: \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1&Project=\" + project + \"&Metric=\" + metric,\n        method: \"GET\"\n      };\n      return this.backendSrv.datasourceRequest({\n          url: this.buildRealUrl(param),\n          method: 'GET'\n      }).then(response_meta => {\n          var data_meta = response_meta.data;\n          if (data_meta.ErrorCode == 200 && data_meta.Success == true) {\n            var resource = data_meta.Resources.Resource;\n            if(resource.length == 0 || this.isEmpty(resource[0].Dimensions)){\n              return;\n            }\n            var dimension = resource[0].Dimensions.split(\",\");\n            var datapoints = JSON.parse(data.Datapoints);\n            datapoints.map(datapoint =>{\n              var datapointInfo = \"{\\\"\";\n              dimension.forEach(function(value,index){\n                value = value.replace(/\"/g,\"\");\n                if(value != \"userId\"){\n                  datapointInfo += value +\"\\\":\\\"\"+datapoint[value] +\"\\\"\";\n                  if(index == dimension.length - 1){\n                    datapointInfo +=\"}\";\n                  }else{\n                    datapointInfo +=\";\\\"\";\n                  }\n                }\n              });\n              //去重\n              if(result.length == 0){\n                if(dimensions.length == 0){\n                  result.push(datapointInfo);\n                }else if(dimensions.length > 0 && !dimensions.includes(datapointInfo)){\n                  result.push(datapointInfo);\n                }\n              }else if(result.length > 0 && !result.includes(datapointInfo)){\n                if(dimensions.length == 0){\n                  result.push(datapointInfo);\n                }else if(dimensions.length > 0 && !dimensions.includes(datapointInfo)){\n                  result.push(datapointInfo);\n                }\n              }\n            })\n            return this.util.arrayToMap(result);\n        }\n      });\n    }).catch(function (error) {\n      console.log(error);\n      return;\n    });\n  }\n\n  // 暂时无翻页功能,无nextToken字段返回\n  tagsFilter(type, nextToken, path, tagType, tagKey) {\n    var reqUrl = path;\n    if(!this.isEmpty(nextToken)){\n      reqUrl += \"&NextToken=\" + nextToken;\n    }\n    var param = {\n      path: reqUrl,\n      method: \"GET\"\n    };\n    var realUrl = \"\";\n    if(\"ECS\" == type){\n      realUrl = this.buildECSRealUrl(param);\n      return this.backendSrv.datasourceRequest({\n        url: realUrl,\n        method: 'GET'\n      }).then(response => {\n        var result =[];\n        var data = response.data;\n        var tags = data.Tags.Tag;\n        if(tags.length > 0){\n          tags.forEach(tag => {\n            if(\"key\" == tagType){\n              if(!result.includes(tag.TagKey)){\n                result.push(tag.TagKey);\n              }\n            }else if(\"value\" == tagType){\n              if(tag.TagKey == tagKey || tagKey == \"\"){\n                var value = tag.TagKey + \":/:\" + tag.TagValue\n                if(!result.includes(value)){\n                  result.push(value);\n                }\n              }\n            }\n          });\n        }\n        return result;\n      })\n    }else if(\"RDS\" == type){\n      realUrl = this.buildRDSRealUrl(param);\n      return this.backendSrv.datasourceRequest({\n        url: realUrl,\n        method: 'GET'\n      }).then(response => {\n        var result =[];\n        var data = response.data;\n        var tags = data.Items.TagInfos;\n        if(tags.length > 0){\n          tags.forEach(tag => {\n            if(\"key\" == tagType){\n              if(!result.includes(tag.TagKey)){\n                result.push(tag.TagKey);\n              }\n            }else if(\"value\" == tagType){\n              if(tag.TagKey == tagKey || tagKey == \"\"){\n                var value = tag.TagKey + \":/:\" + tag.TagValue\n                if(!result.includes(value)){\n                  result.push(value);\n                }\n              }\n            }\n          });\n        }\n        return result;\n      })\n    }\n  }\n\n  listTagResources(type, regionId, resourceType, resourceId, tag){\n    type = this.isEmpty(type) ? \"ECS\" : type;\n    regionId = this.isEmpty(regionId) ? \"cn-hangzhou\" : regionId;\n    if(\"ECS\" == type){\n      resourceType = this.isEmpty(resourceType) ? \"instance\" : resourceType;\n    }else if(\"RDS\" == type){\n      resourceType = this.isEmpty(resourceType) ? \"INSTANCE\" : resourceType;\n    }\n    var path = \"/?Action=ListTagResources&RegionId=\"+regionId+\"&ResourceType=\" + resourceType;\n    for(var i = 0; i < resourceId.length; i++){\n      if(50 > i){\n        var v = resourceId[i];\n        if(!this.isEmpty(v)){\n          path += \"&ResourceId.\" + (parseInt(i) + 1).toString() + \"=\" + v;\n        }\n      }\n    }\n    var tag_key_array = [];\n    var tag_value_array = [];\n    tag.forEach(t =>{\n      if(!this.isEmpty(t)){\n        if(t.indexOf(\":/:\") != -1){\n          var t_split = t.split(\":/:\");\n          if(!tag_key_array.includes(t_split[0])){\n            tag_key_array.push(t_split[0]);  \n          }\n          if(!tag_value_array.includes(t_split[1])){\n            tag_value_array.push(t_split[1]);\n          }\n        }\n      }\n    });\n    if(tag_key_array.length > 0){\n      for(var i = 0; i < tag_key_array.length; i++){\n        var key = tag_key_array[i];\n        path += \"&Tag.\" + (parseInt(i) + 1).toString() + \".Key=\" + key;\n      }\n    }else if(tag_key_array.length == 0 && tag.length > 0){\n      for(var i = 0; i < tag.length; i++){\n        var key = tag[i];\n        path += \"&Tag.\" + (parseInt(i) + 1).toString() + \".Key=\" + key;\n      }\n    }\n    var nextToken = \"\";\n    return this.tagList(type, nextToken, path, tag_value_array).then(rep =>{\n      var distinct_result = []\n      rep.forEach(instanceId =>{\n        if(!distinct_result.includes(instanceId)){\n          distinct_result.push(instanceId);\n        }\n      })\n      return this.util.arrayToMap(distinct_result);\n    });\n  }\n  // 处理nextToken问题\n  tagList(type, nextToken, path, tag_value_array) {\n    var reqUrl = path;\n    if(!this.isEmpty(nextToken)){\n      reqUrl += \"&NextToken=\" + nextToken;\n    }\n    var param = {\n      path: reqUrl,\n      method: \"GET\"\n    };\n    var realUrl = \"\";\n    if(\"ECS\" == type){\n      realUrl = this.buildECSRealUrl(param);\n    }else if(\"RDS\" == type){\n      realUrl = this.buildRDSRealUrl(param);\n    }\n    return this.backendSrv.datasourceRequest({\n      url: realUrl,\n      method: 'GET'\n    }).then(response => {\n      var result =[];\n      var data = response.data;\n      var tagResource = data.TagResources.TagResource;\n      if(tagResource.length > 0){\n        tagResource.forEach(resource => {\n          if(tag_value_array.length > 0){\n            if(tag_value_array.includes(resource.TagValue)){\n              result.push(resource.ResourceId);\n            }\n          }else {\n            result.push(resource.ResourceId);\n          }\n        })\n      };\n      if(this.isEmpty(data.NextToken)){\n        return result;\n      }else{\n        return this.tagList(type, data.NextToken, path, tag_value_array).then(nextList =>{\n          return result.concat(nextList);\n        });\n      }\n    })\n  }\n\n  // 根据云监控API文档处理URL签名,做封装调用接口用\n  buildRealUrl(param) {\n    var signer = new CmsSigner({\n        accessKeyId: this.util.base64_decode(this.jsonData.cmsAccessKey),\n        secretAccessKey: this.util.base64_decode(this.jsonData.cmsSecretKey),\n        version: this.cmsVersion\n    }, param);\n    signer.addAuthorization();\n    return this.basePath + signer.request.path;\n  }\n\n  // 根据ECS API文档处理URL签名,做封装调用接口用\n  buildECSRealUrl(param){\n    var signer = new CmsSigner({\n        accessKeyId: this.util.base64_decode(this.jsonData.cmsAccessKey),\n        secretAccessKey: this.util.base64_decode(this.jsonData.cmsSecretKey),\n        version: this.ecsVersion\n    }, param);\n    signer.addAuthorization();\n    return this.ecsBasePath + signer.request.path;\n  }\n\n  // 根据RDS API文档处理URL签名,做封装调用接口用\n  buildRDSRealUrl (param){\n    var signer = new CmsSigner({\n        accessKeyId: this.util.base64_decode(this.jsonData.cmsAccessKey),\n        secretAccessKey: this.util.base64_decode(this.jsonData.cmsSecretKey),\n        version: this.rdsVersion\n    }, param);\n    signer.addAuthorization();\n    return this.rdsBasePath + signer.request.path;\n  }\n  \n  // 判断对象是否为空对象 true 空 \n  isEmpty(obj) { \n    var re = new RegExp(\"^[ ]+$\");\n    if(!obj || obj == \"null\" || obj == null || obj == \" \" || obj == \"\" \n      || obj == '\"\"' || re.test(obj) || typeof(obj) == \"undefined\"){\n      return true\n    }// 为空\n    return false; // 不为空\n  }\n}"]}