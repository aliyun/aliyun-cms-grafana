{"version":3,"sources":["../src/signer.js"],"names":["SHA","CmsSigner","credentials","request","date","Date","globalQuery","accessKeyId","String","getTime","randomNumbers","toISOString","replace","parts","Object","keys","forEach","key","push","encodeURIComponent","path","indexOf","join","signature","sign","secretAccessKey","stringToSign","count","num","i","Math","floor","random","r","s","method","canonicalizedQueryString","that","querystring","split","resource","body","resources","arrayEach","call","param","pos","name","slice","value","undefined","decodeURIComponent","sort","a","b","length","cmsEscape","array","iterFunction","idx","hasOwnProperty","ret","parseInt","clearString","secret","string","hmac","digest","fn","jsSHA","shaObj","setHMACKey","update","getHMAC"],"mappings":"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","file":"signer.js","sourcesContent":["import {SHA} from \"./sha1\";\n\nexport class CmsSigner {\n\n    constructor(credentials,request) {\n        this.credentials = credentials;\n        this.request = request;\n    }\n\n    addAuthorization() {\n        var date = new Date();\n        var globalQuery = {\n            'Format': 'JSON',\n            'Version': '2018-03-08',\n            'AccessKeyId': this.credentials.accessKeyId,\n            'SignatureMethod': 'HMAC-SHA1',\n            'SignatureVersion': '1.0',\n            'SignatureNonce': String(date.getTime()) + this.randomNumbers(4),\n            'Timestamp': date.toISOString().replace(/\\.\\d{3}/, '')\n        };\n\n        var parts = [];\n        Object.keys(globalQuery).forEach(function (key) {\n            parts.push(key + '=' + encodeURIComponent(globalQuery[key]));\n        });\n        this.request.path += (this.request.path.indexOf('?') == -1 ? '?' : '&') + parts.join('&');\n        var signature = this.sign(this.credentials.secretAccessKey, this.stringToSign());\n        this.request.path += '&Signature=' + encodeURIComponent(signature);\n    }\n\n    randomNumbers(count) {\n        var num = '';\n        for (var i = 0; i < count; i++) {\n            num += Math.floor(Math.random() * 10);\n        }\n        return num;\n    }\n\n    stringToSign() {\n        var r = this.request;\n        var s = r.method + '&%2F&' + encodeURIComponent(this.canonicalizedQueryString());\n        return s;\n    }\n\n    canonicalizedQueryString() {\n        var that = this;\n        var r = this.request;\n        var querystring = r.path.split('?')[1];\n        var resource = '';\n        if (r.body) {\n            querystring += '&' + r.body;\n        }\n        if (querystring) {\n            var resources = [];\n            this.arrayEach.call(this, querystring.split('&'), function (param) {\n                var pos = param.indexOf('=');\n                var name = param.slice(0, pos);\n                var value = param.slice(pos + 1);\n                var resource = {name: name};\n                if (value !== undefined) {\n                    resource.value = decodeURIComponent(value);\n                }\n                resources.push(resource);\n            });\n            resources.sort(function (a, b) {\n                return a.name < b.name ? -1 : 1;\n            });\n            if (resources.length) {\n                querystring = [];\n                this.arrayEach(resources, function (resource) {\n                    if (resource.value === undefined)\n                        querystring.push(that.cmsEscape(resource.name));\n                    else\n                        querystring.push(that.cmsEscape(resource.name) + '=' + that.cmsEscape(resource.value));\n                });\n                resource += querystring.join('&');\n            }\n        }\n        return resource;\n    }\n\n    arrayEach(array, iterFunction) {\n        for (var idx in array) {\n            if (array.hasOwnProperty(idx)) {\n                var ret = iterFunction.call(this, array[idx], parseInt(idx, 10));\n                if (ret === {}) break;\n            }\n        }\n    }\n\n    cmsEscape(clearString) {\n        return encodeURIComponent(clearString)\n            .replace(/\\!/gi, '%21')\n            .replace(/\\'/gi, '%27')\n            .replace(/\\(/gi, '%28')\n            .replace(/\\)/gi, '%29')\n            .replace(/\\*/gi, '%2A')\n    }\n\n    sign(secret, string) {\n        return this.hmac(secret + '&', string, 'base64', 'sha1');\n    }\n\n    hmac(key, string, digest, fn) {\n        if (!digest) digest = 'binary';\n\n        if (digest === 'buffer') {\n            digest = undefined;\n            // todo: 不支持 buffer 类型的 hash\n            return \"\";\n        }\n\n        if (!fn) fn = 'sha256';\n\n        if (typeof string != 'string') {\n            //string = new Buffer(string);\n            // todo: 目前只支持 string\n            return \"\";\n        }\n        var jsSHA = SHA();\n        var shaObj;\n        switch (fn) {\n            case \"md5\":\n                // todo: 不支持 md5\n                return \"\";\n            case \"sha1\":\n                shaObj = new jsSHA(\"SHA-1\", \"TEXT\");\n                break;\n            case \"sha256\":\n                shaObj = new jsSHA(\"SHA-256\", \"TEXT\");\n                break;\n            case \"sha512\":\n                shaObj = new jsSHA(\"SHA-512\", \"TEXT\");\n                break;\n            default:\n                return \"\";\n        }\n\n        shaObj.setHMACKey(key, \"TEXT\");\n\n        shaObj.update(string);\n\n        switch (digest) {\n            case \"binary\":\n                return shaObj.getHMAC(\"BYTES\");\n            case \"hex\":\n                return shaObj.getHMAC(\"HEX\");\n            case \"base64\":\n                return shaObj.getHMAC(\"B64\");\n            default:\n                return \"\";\n        }\n    }\n}\n"]}